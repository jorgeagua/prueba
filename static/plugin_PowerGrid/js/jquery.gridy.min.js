/*!
 * jQuery Gridy - A Grid Plugin - http://wbotelhos.com/gridy
 * 
 * @author	Washington Botelho
 * @twitter wbotelhos
 * @version 0.2.0
 * 
 * Licensed under The MIT License
 * http://opensource.org/licenses/mit-license.php
 * 
 */

(function(b){var a={init:function(c){},getSize:function(c){return(isNaN(parseInt(c)))?c:c+"px";},getNumber:function(c){return(c<10)?"0"+c:c;},getError:function(c){return(c.responseText)?c.responseText.substring(c.responseText.indexOf("(")+1,c.responseText.indexOf(")")):c.statusText;},getNumber:function(c){return(c<10)?"0"+c:c;},debug:function(c){if(window.console&&window.console.log){window.console.log(c);}}};b.fn.gridy=function(Y){if(this.length==0){a.debug("Selector invalid or missing!");return;}else{if(this.length>1){return this.each(function(){b.fn.gridy.apply(b(this),[Y]);});}}var w=b.extend({},b.fn.gridy.defaults,Y),N=this.attr("id"),o=b(this).empty(),K=b('<input id="current-page" type="hidden" value="'+w.page+'"/>').appendTo(o),m=b('<input id="current-sort-name" type="hidden" value="'+w.sortName+'"/>').appendTo(o),r=b('<input id="current-sort-order" type="hidden" value="'+w.sortOrder+'"/>').appendTo(o);if(N===undefined){N="gridy-"+o.index();o.attr("id",N);}o.addClass(w.templateStyle).data("options",w);var P=null,U=null;if(w.searchOption){var Z=b('<div class="gridy-search"/>').appendTo(o);P=b('<input id="search" type="text" size="40" value="'+((w.search=="")?w.searchText:w.search)+'" title="'+w.searchText+'"/>').appendTo(Z);P.blur(function(){if(P.val()==""){P.removeClass("gridy-typed").val(w.searchText);}}).focus(function(){if(P.val()==w.searchText){P.addClass("gridy-typed").val("");}}).keypress(function(i){if((i.keyCode?i.keyCode:i.which)==13){O(1,m.val(),r.val());}});U=b('<input type="button" value="'+w.searchButtonLabel+'" title="'+w.searchButtonTitle+'"/>').appendTo(Z);U.click(function(){O(1,m.val(),r.val());});}function z(ac,ad,ah,ag){var ab=ac.parent().parent(),af=w.headersName.length>0&&ab.attr("class")=="gridy-header";if(ag){var i=ab.find("a.gridy-sorted").attr("rel","desc").removeClass("gridy-sorted");i=(af)?i.next("div"):i.prev("div");i.removeClass().addClass(w.arrowNone);}ac.attr("rel",ad).addClass("gridy-sorted");var ae=(af)?ac.next("div"):ac.prev("div");ae.removeClass().addClass(ah);}var s=null,I=null;if(w.sortersName.length>0){var y="",R="",J="";for(var W=0;W<w.sortersName.length;W++){R=w.sortersName[W][0];J=w.sortersName[W][1];y+='<div class="gridy-sorter-item"><div class="'+w.arrowNone+'"></div><a id="sort-by-'+R+'" href="javascript:void(0);" name="'+R+'" rel="desc">'+J+"</a></div>";}s=b('<div class="gridy-sorter-bar"/>').css("width",a.getSize(w.sorterWidth)).html(y).appendTo(o);I=s.children().delegate("a","click",G);var C=I.find("a#sort-by-"+w.sortName);if(C.length){var E=(w.sortOrder=="asc")?w.arrowUp:w.arrowDown,u=false;z(C,w.sortOrder,E,u);}}function G(){h(b(this));}function h(i){var ad=i.attr("name"),ac=i.attr("rel"),ab=(ac=="desc")?"asc":"desc",af=(ac=="desc")?w.arrowUp:w.arrowDown,ae=i.parent().parent().find("a.gridy-sorted").length>0;z(i,ab,af,ae);O(K.val(),ad,ab);}var S=null;if(w.loadingOption){S=b('<div class="'+w.loadingIcon+'"><div>'+w.loadingText+"</div></div>").appendTo(o).children();}var F=null;if(w.resultOption){F=b('<div class="gridy-result"/>').appendTo(o);}var l=null,k=null;if(w.headersName.length>0){l=b('<div class="gridy-header"/>').appendTo(o);var B=null,Q=null,n="",L="";if(w.headersWidth.length<=0){if(w.colsWidth.length>0){w.headersWidth=w.colsWidth;}else{a.debug(N+": headersWith and colsWidth attributes invalid or missing!");return;}}for(var W=0;W<w.headersName.length;W++){n=w.headersName[W][0];L=w.headersName[W][1];Q=b("<a/>",{href:"javascript:void(0);",html:L});B=b('<div class="gridy-head-item"/>');if(n){Q.attr({id:"sort-by-"+n,name:n,rel:"desc"});var T=b("<div/>",{"class":w.arrowNone});B.append(Q,T);}else{Q.attr("class","gridy-no-sort");B.append(Q);}if(w.headersName[W][2]){B.addClass(w.headersName[W][2]);}B.css("width",w.headersWidth[W]).appendTo(l);}k=l.children().delegate('a:not(".gridy-no-sort")',"click",G);var C=b("div.gridy-header a#sort-by-"+w.sortName);if(C.length){var E=(w.sortOrder=="asc")?w.arrowUp:w.arrowDown,u=false;z(C,w.sortOrder,E,u);}}var e=b('<div class="gridy-content"/>').css({height:a.getSize(w.height),width:a.getSize(w.width)}).appendTo(o);function p(i){if(w.loadingOption){if(i){S.fadeIn("fast");e.addClass("gridy-fade");}else{S.fadeOut();e.removeClass("gridy-fade");}}}function v(){if(w.noResultOption){e.html('<p class="gridy-no-result">'+w.noResultText+"</p>");if(w.resultOption){F.html(F.html().replace(/\d+/g,"--"));}if(w.searchOption){P.focus().select();}}}var A=null;if(w.findsName.length>0||w.rowsNumber.length>0||w.messageOption){A=b('<div class="gridy-footer"/>').css("width",a.getSize(w.width)).appendTo(o);}var g=null;if(w.findsName.length>0){g=b('<div class="gridy-find-option"><select></select></div>').appendTo(A).children();var q=false,D="",f="",j="";for(var W=0;W<w.findsName.length;W++){f=w.findsName[W][0];j=w.findsName[W][1];D+='<option value="'+f+'">'+j+"</option>";if(f==w.find){q=true;}}if(!q){g.html('<option value="'+w.find+'" checked="checked">'+w.find+"</option>");}g.append(D).val(w.find).change().change(function(i,ab){if(w.searchOption&&w.searchFocus){P.focus();}}).children('option[value="'+w.find+'"]').attr("checked","checked");}var V=null;if(w.rowsNumber.length>0){V=b('<div class="gridy-row-option"><select></select></div>').appendTo(A).children();var X=(w.rows<1)?1:w.rows,M=false,D="",aa="";for(var W=0;W<w.rowsNumber.length;W++){aa=w.rowsNumber[W];if(aa==X){M=true;}D+='<option value="'+aa+'">'+a.getNumber(aa)+"</option>";}if(!M){V.html('<option value="'+X+'" checked="checked">'+a.getNumber(X)+"</option>");}V.append(D).val(X).change().change(function(i,ab){O(1,m.val(),r.val());}).children('option[value="'+X+'"]').attr("checked","checked");}if(w.searchTarget){P.parent().appendTo(w.searchTarget);}if(w.findTarget){g.parent().appendTo(w.findTarget);}if(w.rowsTarget){V.parent().appendTo(w.rowsTarget);}var t=null;if(w.buttonOption){t=b('<div class="gridy-buttons"/>').css("width",a.getSize(w.buttonsWidth)).appendTo(o);}var d=null;if(w.messageOption){d=b('<div class="gridy-message"/>').appendTo(A);}function H(i){if(w.messageOption){d.html(i).show();setTimeout(function(){d.fadeOut();},w.messageTimer);}}O(w.page,w.sortName,w.sortOrder);function x(i){if(i){if(w.searchOption){P.removeAttr("readonly");U.removeAttr("disabled");}if(w.sortersName.length>0){I.delegate("a","click",G);k.delegate('a:not(".gridy-no-sort")',"click",G);}if(w.buttonOption){t.children().removeAttr("disabled");}if(w.findsName.length>0){g.removeAttr("disabled");}if(w.rowsNumber.length>0){V.removeAttr("disabled");}}else{if(w.searchOption){P.attr("readonly","readonly");U.attr("disabled","disabled");}if(w.sortersName.length>0){I.undelegate("a","click");k.undelegate('a:not(".gridy-no-sort")',"click");}if(w.buttonOption){t.children().attr("disabled","disabled");}if(w.findsName.length>0){g.attr("disabled","disabled");}if(w.rowsNumber.length>0){V.attr("disabled","disabled");}}}function c(al,ak,ab,at,ar){if(typeof(al)=="string"){al=b.parseJSON(al);}if(w.before){var aj=w.before.apply(o,[al,ak,ab,at]);if(aj){al=aj;}}if(al.total==0){v();x(true);return;}else{if(w.sortersName.length>0){s.show();}}var an=al.entityList;e.html(b("#"+w.template).tmpl(an));if(w.colsWidth){e.children("div").addClass("gridy-row").each(function(){b(this).children("div").addClass("gridy-column").each(function(i){b(this).width(w.colsWidth[i]);});});}var aq=al.total%ar,af=(al.total-aq)/ar;if(aq>0){af++;}if(w.resultOption){var au=w.resultText.replace(/{from}/,a.getNumber(ak)).replace(/{to}/,a.getNumber(af)).replace(/{total}/,a.getNumber(al.total));F.html(au);}if(w.buttonOption){if(al.total>ar){var ap='<input type="button" value="..." disabled="disabled" class="gridy-empty"/>&nbsp;',ax="",ac=0,ad=null,ai=1,ah=w.buttonMax,ao=(w.buttonMax%2==0);if(w.buttonMax>af){ah=af;}else{ah=w.buttonMax;}if(ao){ad=Math.ceil(ah/2);ai=ak-ad+1;}else{ad=Math.floor(ah/2);ai=ak-ad;}var ae=parseInt(ak)+ad;if(ai==0){ae++;ai=1;}if(ai<0){ae+=Math.abs(ai)+1;ai=1;}if(ae>af){if(ai>1){ai-=(ae-af);}ae=af;}var ag=af>ah,am=ag&&ak>((ao)?ad:ad+1),aw=ag&&ak<(af-ad);if(am){ax='<input type="button" value="&lsaquo;" alt="'+w.buttonBackTitle+'" title="'+w.buttonBackTitle+'" class="gridy-back"/>&nbsp;';ax+=ap;}for(var av=ai;av<=ae;av++){ac=a.getNumber(av);ax+='<input type="button" value="'+ac+'" alt="'+ac+'" title="'+w.buttonTitle+" "+ac+'"/>&nbsp;';}if(aw){ax+=ap;ax+='<input type="button" value="&rsaquo;" alt="'+w.buttonNextTitle+'" title="'+w.buttonNextTitle+'" class="gridy-next"/>&nbsp;';}t.html(ax).children(':not(".gridy-empty")').click(function(){O(parseInt(this.alt,10),m.val(),r.val());});if(am){t.children(".gridy-back").click(function(){O(ak-1,m.val(),r.val());});}if(aw){t.children(".gridy-next").click(function(){O(ak+1,m.val(),r.val());});}}else{t.empty();}b('input[value="'+a.getNumber(ak)+'"]').attr("disabled","disabled").addClass("gridy-active");}x(true);K.val(ak);m.val(ab);r.val(at);}function O(ad,ac,ab){x(false);p(true);var i=w.search,ae=(w.rowsNumber.length>0)?V.val():w.rows,af=(w.findsName.length>0)?g.val():w.find;if(w.searchOption){i=(P.val()==w.searchText)?"":P.val();if(w.searchFocus){P.focus();}}if(w.data!=null){c(w.data,ad,ac,ab);return;}if(w.debug){a.debug("query string: search="+i+"&page="+ad+"&sortName="+ac+"&sortOrder="+ab+"&find="+af+"&rows="+ae+w.params);}b.ajax({cache:w.cache,contentType:w.contentType,dataType:w.dataType,jsonp:w.jsonp,jsonpCallback:w.jsonpCallback,type:w.type,url:w.url,data:"search="+i+"&page="+ad+"&sortName="+ac+"&sortOrder="+ab+"&find="+af+"&rows="+ae+w.params,success:function(ah){c(ah,ad,ac,ab,ae);var ag=(w.scroll)?"-scroll":"";if(w.hoverFx){e.children().mouseenter(function(){b(this).addClass("gridy-item-hover"+ag);}).mouseleave(function(){b(this).removeClass("gridy-item-hover"+ag);});}if(w.clickFx){e.children().click(function(ai){var aj=b(this);if(!ai.shiftKey){aj.parent().children("div.gridy-item-active"+ag).removeClass("gridy-item-active"+ag);}aj.toggleClass("gridy-item-active"+ag);});}if(w.success){w.success();}},error:function(ai,ag,ah){H(a.getError(ai));if(w.error){w.error();}},complete:function(){p(false);if(w.scroll){if(w.height=="auto"){a.debug(N+": height attribute missing!");}e.css({border:"1px solid #BBB",overflow:"auto"}).children("div").addClass("gridy-scroll").end().children("div:last").css("border-bottom-color","#FFF");}if(w.complete){w.complete();}}});}return o;};b.fn.gridy.reload=function(f,e){var c=b(f),d=c.data("options");if(e!==undefined){b.each(e,function(g,h){if(d[g]===undefined){a.debug("'"+g+"' is an invalid attribute!");}else{if(h!=d[g]){d[g]=h;}}});c.data("options",d);}return c.gridy(d);};b.fn.gridy.defaults={arrowDown:"gridy-arrow-down",arrowNone:"gridy-arrow-none",arrowUp:"gridy-arrow-up",before:null,buttonBackTitle:"&lsaquo; Back",buttonMax:10,buttonNextTitle:"Next &rsaquo;",buttonOption:true,buttonsWidth:"auto",buttonTitle:"page",cache:false,clickFx:false,colsWidth:[],complete:null,contentType:"application/x-www-form-urlencoded; charset=utf-8",dataType:"json",debug:false,error:null,find:"",findsName:[],findTarget:null,headersName:[],headersWidth:[],height:"auto",hoverFx:false,jsonp:false,jsonpCallback:"callback",loadingIcon:"gridy-loading",loadingOption:true,loadingText:"Loading...",messageOption:true,messageTimer:4000,noResultOption:true,noResultText:"No items found!",page:1,params:"",resultOption:true,resultText:"Displaying {from} - {to} of {total} items",rows:10,rowsNumber:[5,10,25,50,100],rowsTarget:null,scroll:false,search:"",searchButtonLabel:"search",searchButtonTitle:"Start the search",searchFocus:true,searchOption:true,searchTarget:null,searchText:"",sortersName:[],sorterWidth:"auto",sortName:"",sortOrder:"asc",success:null,template:"template",templateStyle:"gridy-default",type:"get",url:"/gridy",width:"auto"};})(jQuery);